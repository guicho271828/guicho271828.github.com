<!doctype html>
<html lang="en"> <head> <title>CL-USER&gt; (start-up (the engine *bp-ze*))</title> <meta http-equiv="content-type" content="text/html; charset=UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link href="//fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" /> <link href="//fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /> <link href= "/css/style.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="/rss.xml" type="application/rss+xml" /> <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'foo']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script> </head> <body> <div class="navigation"> <span class="sitenav"> <a href="/">CL-USER&gt; (start-up (the engine *bp-ze*))</a> </span> <span class="sitenav"> <a href="/profile/">Profile</a> </span><span class="sitenav"> <a href="/publications/">Publications</a> </span><span class="sitenav"> <a href="http://twitter.com/guicho271828">Twitter</a> </span><span class="sitenav"> <a href="http://github.com/guicho271828">Github</a> </span><span class="sitenav"> <a href="https://www.linkedin.com/in/masataro-asai-158a0638/">LinkedIn</a> </span> </div> <div id="content"> <h1 class="title">Content from 2013-05</h1> <div class="article-meta"> <a class="article-title" href="/posts/紹介-ライブラリ-Inner-conditional.html">紹介: ライブラリ Inner-conditional</a> <div class="date"> posted on 2013-05-06 20:41</div> <div class="article"><p><a href="https://github.com/guicho271828/inner-conditional" >inner-conditional</a> の紹介をします。</p>

<h1>Q.なにができるの?</h1>

<p>A. ループ(など)の中の条件判定を、内側に書いたままで外側に出せます。</p>

<!-- more -->

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
    <span class="paren2">(<span class="code">iter <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
          <span class="paren3">(<span class="code">print i</span>)</span>
          <span class="paren3">(<span class="code">inner <span class="paren4">(<span class="code">body</span>)</span>
            <span class="paren4">(<span class="code"><i><span class="symbol">if</span></i> flag
                <span class="paren5">(<span class="code">body <span class="paren6">(<span class="code">princ <span class="string">"loop on"</span></span>)</span></span>)</span>
                <span class="paren5">(<span class="code">body <span class="paren6">(<span class="code">princ <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>と書くと、</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">IF</span></i> FLAG
    <span class="paren2">(<span class="code"><i><span class="symbol">WITH-INNER</span></i> <span class="paren3">(<span class="code">BODY</span>)</span>
      <span class="paren3">(<span class="code">ITER
        <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
        <span class="paren4">(<span class="code">PRINT I</span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop on"</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><i><span class="symbol">WITH-INNER</span></i> <span class="paren3">(<span class="code">BODY</span>)</span>
      <span class="paren3">(<span class="code">ITER
        <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
        <span class="paren4">(<span class="code">PRINT I</span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
</span></code></pre>

<p>になって、</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">IF</span></i> FLAG
    <span class="paren2">(<span class="code"><i><span class="symbol">PROGN</span></i>
     <span class="paren3">(<span class="code">ITER
       <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
       <span class="paren4">(<span class="code">PRINT I</span>)</span>
       <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop on"</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><i><span class="symbol">PROGN</span></i>
     <span class="paren3">(<span class="code">ITER
       <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
       <span class="paren4">(<span class="code">PRINT I</span>)</span>
       <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
</span></code></pre>

<p>になります。うふふ、いいでしょ。キモイ？</p>

<p>この種のループ最適化というと、もとから全て行なってくれるような、とって
も優れた処理系もあるかもしれませんが、なにせ実際に動いているのかどうか
わかりません。(C言語とかって、賢いコンパイラはこういうのが全部デフォルト
で付いているんですかね？) sbclでテストをした結果、 <strong>たしかに</strong> <a href="https://github.com/guicho271828/inner-conditional/blob/master/opt-results.org" >条件判定
の分だけ早くなっていることが確認出来ました。</a></p>

<p>条件判定のタイミングは <code>with-inner</code> の部分ですので、 <code>with-inner</code> をど
こに置くかで判定のタイミングを適切に設定できます。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
  <span class="paren2">(<span class="code">iter <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
        <span class="paren3">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren4">(<span class="code">body2</span>)</span>
          <span class="paren4">(<span class="code">iter <span class="paren5">(<span class="code">for j from 0 to 5</span>)</span>
                <span class="paren5">(<span class="code">format t <span class="string">"~%i: ~a j: ~a"</span> i j</span>)</span>
                <span class="paren5">(<span class="code">inner <span class="paren6">(<span class="code">body2</span>)</span>
                  <span class="paren6">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren1">(<span class="code">evenp i</span>)</span>
                      <span class="paren1">(<span class="code">body2 <span class="paren2">(<span class="code">format t <span class="string">"  i is even"</span></span>)</span></span>)</span>
                      <span class="paren1">(<span class="code">body2 <span class="paren2">(<span class="code">format t <span class="string">"  i is odd"</span></span>)</span></span>)</span></span>)</span></span>)</span>
                <span class="paren5">(<span class="code">inner-if body flag
                          <span class="paren6">(<span class="code">format t <span class="string">"  loop on"</span></span>)</span>
                          <span class="paren6">(<span class="code">format t <span class="string">"  loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>この例では、 <code>body</code> レベルでの条件判定は一番上で、一方 <code>body2</code> レベルの
条件判定はループの二段目で行えます。 <code>inner</code> の方、すなわり条件判定の内
容を実際に書いている方で、そのレベルを指定できます。 <code>(inner-if body
...)</code> というのは構文糖で、 <code>(inner (body) (if ... (body ...)))</code> に展開
されるマクロです。ほかにも数種類あります。</p>

<p><code>inner</code> 内で使えるのは <code>if</code> だけじゃありません。 <code>cond</code> でも、 <code>case</code>
でも、オレオレマクロでもなんでも大丈夫です。特殊なマクロで制御構造を登
録する必要はありません。必要なのはこれだけ、すなわち、</p>

<pre><code>継続であるかのように body を呼ぶこと
</code></pre>

<p>です。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
  <span class="paren2">(<span class="code">iter
    <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
    <span class="paren3">(<span class="code">inner <span class="paren4">(<span class="code">body</span>)</span>
      <span class="paren4">(<span class="code">case <span class="paren5">(<span class="code"><i><span class="symbol">progn</span></i> <span class="paren6">(<span class="code">incf count</span>)</span>
                   <span class="paren6">(<span class="code">mod arg 3</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">0 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"divided. i*3 =~a~%"</span>
                         <span class="paren2">(<span class="code">* i 3</span>)</span></span>)</span>
                 <span class="paren1">(<span class="code">format t <span class="string">"divided. i*3 =~a~%"</span>
                         <span class="paren2">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">1 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"modulo 1. i*3 + 1 =~a~%"</span>
                         <span class="paren2">(<span class="code">+ 1 <span class="paren3">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">2 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"modulo 2. i*3 + 2 =~a~%"</span>
                         <span class="paren2">(<span class="code">+ 2 <span class="paren3">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>だってほら、全然違いますけど、内側と外側がひっくり返るじゃないですか。
プログラムは実際には <strong>一番最初に</strong> 条件分岐をして、そして <code>inner</code> の中身
が <code>body</code> の引数を代入した状態で実行されるんです。似てませんか？ <strong>継続
に！</strong></p>

<p>続きはまた今度。このライブラリのもうひとつのいいところ、 あなたのライブ
ラリに、 <strong>条件分岐を隠したまま最適化できる能力</strong> を与えられる点について
お話しします。</p>
</div> </div><div class="article-meta"> <a class="article-title" href="/posts/Common-Lisp-で-Code-Walker-を実装するなら-その②.html">Common Lisp で Code Walker を実装するなら その②</a> <div class="date"> posted on 2013-05-06 15:26</div> <div class="article"><p>前回の続き。状態を持つmacroletを書くにはどうすればいいのか！？
これが答えだ！</p>

<!-- more -->

<h1>回答: Compile-time で restart-bind</h1>

<p>{% include_code サンプルコード lang:cl walk-tree.lisp %}</p>

<p>ね、面白いでしょ？ANSI Hyperspecにある <code>*macroexpand-hook*</code> をうまく使っ
てみました。 <code>my-macro-start</code> が変な感じになっているのは、ここで書いた
構造が入れ子になってる可能性があるので、スタックフレームをエミュレート
しているんです。 <strong>ん、え、スタック？</strong></p>

<p>Schemerな人は言いたいことがすぐにわかることでしょう。ANSIの設計の何が悪
いって、 <code>defmacro</code> が <strong>継続を引数に取ってくれない</strong> ことなんですよ。だ
から、外側のマクロを展開した時に、内側のマクロ展開を行うときのレキシカ
ル環境を操作できない。それだから中途半端な code-walker しか <em>簡単には</em>
実装できないわけです。</p>

<p>うーん、えーと、もう2,3個思いついたはずなんですけど、思いつかなかった
ので、一つです。なにか他に案がある人はtwitterかgithub経由で教えてくだ
さい(^^)</p>
</div> </div><div class="article-meta"> <a class="article-title" href="/posts/Common-Lisp-で-Code-Walker-を実装するなら.html">Common Lisp で Code Walker を実装するなら</a> <div class="date"> posted on 2013-05-05 22:01</div> <div class="article"><p>Common Lispを使っていると、みんな一度はマクロでDSLを実装したくなります
よね。みなさんどうしてるでしょう。例えば、自分の作ったマクロ
<code>my-macro</code> の中では、特定のS式、たとえば=my-clause= に特殊な意味を持つ
節としての役割を与えたい時。マクロは引数のS式を好きに扱えるので、なんで
もありです。だから、例えば。</p>

<!-- more -->

<pre><code>
(defun walk-tree (fn tree)
  (funcall fn tree
           (lambda (branch)
             (mapcar (lambda (branch)
                       (walk-tree fn branch))
                     branch))))

(defun precompile-1-layer (sym fn form)
  (walk-tree
   (lambda (subform cont)
     (if (and (consp subform)
              (equalp sym (car subform)))
         (apply fn (cdr subform))
         (if (consp subform)
             (funcall cont subform)
             subform)))
   form))</code></pre>

<p>みたいなのを定義して、該当シンボルを手動で検知して <code>macroexpand</code> の真似
をする、といった手を使うことができちゃいます。</p>

<pre><code>
(defmacro my-macro (&body body)
  `(progn
     ,@(precompile-1-layer
        'my-clause
        (lambda (&body body)
          (progn (print :hi!)
                 ,@body))
        body)))

(my-macro
 (iter (for i below 5)
       (print i)
       (my-clause
        (print :stupid!))))

;; macroexpansion result

(progn
  (iter (for i below 5)
        (print i)
        (progn
          (print :hi!)
          (print :stupid!))))  
</code></pre>

<p>いやまあ、ここで問題になるのが、 <code>macrolet</code> で指定した内容が全然反映され
ないという事ですね。一言で言えば、頭悪い。</p>

<pre><code>
(my-macro
 (macrolet ((my-clause (&body body)
              (subst :im-not-stupid! :stupid! body)))
   (iter (for i below 5)
         (print i)
         (my-clause
          (print :stupid!)))))
</code></pre>

<pre><code>
(progn
 (macrolet ((my-clause (&body body)
              (subst :im-not-stupid! :stupid! body)))
  (iter (for i below 5)
        (print i)
        (progn
          (print :hi!)
          (print :stupid!)))))
</code></pre>

<p>my-clauseをバイパスして展開してしまっているので、内側のmy-clauseが反映
されず、 <code>:stupid!</code> が <code>:im-not-stupid!</code> に変換されずに残っている。この問
題が、<a href="http://m2ym.github.io/blog/2012/04/28/eval-in-macros/" >m2ymさんも言っている</a> <strong>マクロ内でevalするな</strong> 問題です。</p>

<p>でも、evalしないって辛いです。code walkをするなと言っているのと同様。
じゃあどうすればいいのか。</p>

<h1>全部Macroletに展開する</h1>

<p>これは僕が <a href="https://github.com/guicho271828/inner-conditional" >inner-conditional</a> ではじめに取った手法です。
<code>macrolet</code> をどんどんネストさせるわけです。</p>

<pre><code>
(defmacro my-macro (&body body)
  `(macrolet ((my-clause (&body body)
                `(progn (print :hi!)
                        ,@body)))
     ,@body))
</code></pre>

<p>これで今回のコードでは当面の目標は達成されます。でも、問題が・・・。な
にが問題かというと、コンパイル時に変数を触ることができないということ。
例えば上のコードで、</p>

<pre><code>一回目は〇〇に展開し、二回目は☓☓に展開したい。
</code></pre>

<p>とか、</p>

<pre><code>i回目にはiを用いて … に展開したい。その指定は実行時ではダメで、
コンパイル時に定数として挿入したい。
</code></pre>

<p>とかいう需要があるときにどうするか。</p>

<p><code>macrolet</code> はスペシャルフォームなので、そのマクロ定義だけをletで囲む
なんてことはできません。出来れば嬉しいんだけれどねえ…</p>

<pre><code>
(macrolet ((let ((i 0))
             (my-clause (&body body)
                (incf i)
                `(progn (print ,i)
                        ,@body))))
  (do-something))
</code></pre>

<p>ではどうするか。例を示そうと思ったんですが、例を書くだけでも骨が折れる
ようなコードだったので、続きは次の記事で。</p>
</div> </div> <div id="relative-nav">   </div> <div id="tagsoup"> <p>This blog covers <a href="/tag/arduino.html">arduino</a>, <a href="/tag/car.html">car</a>, <a href="/tag/lisp.html">lisp</a>, <a href="/tag/octopress.html">octopress</a>, <a href="/tag/old-blog.html">old-blog</a>, <a href="/tag/research.html">research</a> </div> <div id="monthsoup"> <p>View content from <a href="/date/2017-11.html">2017-11</a>, <a href="/date/2015-01.html">2015-01</a>, <a href="/date/2014-05.html">2014-05</a>, <a href="/date/2014-03.html">2014-03</a>, <a href="/date/2014-01.html">2014-01</a>, <a href="/date/2013-05.html">2013-05</a>, <a href="/date/2013-04.html">2013-04</a>, <a href="/date/2013-03.html">2013-03</a> </div> </div>  <div class="fineprint"> <hr> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="/css/cc-by-sa.png" /> </a> by Masataro Asai <a id="coleslaw-logo" href="https://github.com/redline6561/coleslaw"> <img src="/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </div> </body> </html>