<!doctype html>
<!-- Local Variables: mode : html End: -->
<html lang="en">
<head>
<title>CL-USER&gt; (start-up (the engine *bp-ze*))</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- <link href="//fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" />
--> <!-- <link href="//fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" />
--> <link href= "/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
<link href= "/css/style.css" rel="stylesheet" type="text/css" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" />

</head>
<body>
<nav class="navigation">
<span class="title"> <a href="/">CL-USER&gt; (start-up (the engine *bp-ze*))</a> </span>
<div class="sitenav"> <span class="sitenav"> <a href="/profile/"><i class="fa fa-user" aria-hidden="true"></i> Profile</a> </span>
<span class="sitenav"> <a href="/publications/"><i class="fa fa-book" aria-hidden="true"></i> Publications</a> </span>
<span class="sitenav"> <a href="http://twitter.com/guicho271828"><i class="fa fa-twitter" aria-hidden="true"></i></a> </span>
<span class="sitenav"> <a href="http://github.com/guicho271828"><i class="fa fa-github" aria-hidden="true"></i></a> </span>
<span class="sitenav"> <a href="https://www.linkedin.com/in/masataro-asai-158a0638/"><i class="fa fa-linkedin" aria-hidden="true"></i></a> </span>
 </div> </nav>
<main id="content">
<!-- Local Variables: mode : html End: -->
<article> <header>
<h1>最新版のOrg-mode (8.0 preview)をOctopressと連携させる</h1>
<div class="tags">
Tagged as <a href="/tag/old-blog.html">old-blog</a>
, <a href="/tag/octopress.html">octopress</a>
 </div>
<div class="date">
Written on 2013-03-28 13:15 </div>
</header>
<div class="content">
<p>たぶんこれでいけた。.emacsを編集して、かつRakefileをちょこっと変更する
だけ。基本方針は、File local variables を使って、ファイルを保存すると同
時にorg-modeからmarkdownに変換する。orgのファイルは
<code>$octopress-root$/org/</code> に入れる。そしたら
<code>$octopress-root$/source/_posts</code> にmdファイルが移る。</p>

<!--more-->

<p>Octopressでのブログ生成をEmacsからコマンド一発( <code>M-x octopost</code> など)でやれ
るようになっている。いちいちシェルを開くのもめんどくさい。正直、この程
度だとrakeの必要性がないというか、Emacs Lispとやれることが被ってるんだ
よね。依存関係とか無いし。しかも <code>rake new_post[title]</code> は作ったファイ
ル名を返してくれない。結局、作ったファイルを自動で開くようにするのは面
倒くさくてやらなかった。ただ、一応、フォルダを開くことにはしておいた。
また、 <code>rake preview</code> コマンドをバックグラウンドで自動で起動してくれる。
ただし、起動したバッファを自分で消さないとだめ。</p>

<p>最後に(ここまでする必要あるか？)、 <code>M-x gen-dep</code> で <code>rake gen_deploy</code> 相
当のものができる。</p>

<pre><code>(defvar octopress-repo &quot;~/repos/octopress/&quot;) ;; このアドレスは自由に変更可能
(defvar posts &quot;source/_posts/&quot;)
(defvar org-source &quot;org/&quot;)
(defvar octopress-export-org-to-md-enabled nil)
(defun org-md-try-to-export-to-markdown ()
  (interactive)
  (when octopress-export-org-to-md-enabled
    (let ((md (org-md-export-to-markdown)))
      (shell-command 
       (format &quot;mv -f %s %s&quot; 
               md (concatenate 'string octopress-repo posts))))))

(defun octopost (title)
  (interactive &quot;sInput the new post title: &quot;)
  (shell-command
   (format &quot;cd %s;rake new_post[\&quot;%s\&quot;]&quot; octopress-repo title))
  (octo-preview)
  (find-file (concatenate 'string octopress-repo org-source)))

(defun octopage (title)
  (interactive &quot;sInput the new page title: &quot;)
  (shell-command
   (format &quot;cd %s;rake new_page[\&quot;%s\&quot;]&quot; octopress-repo title))
  (octo-preview)
  (find-file (concatenate 'string octopress-repo org-source)))

(defun octo-preview ()
  (interactive)
  (shell-command
     (format &quot;cd %s;rake preview &amp;&quot; octopress-repo)))
(defun gen-dep ()
  (interactive)
  (shell-command
   (format &quot;cd %s;rake gen_deploy &amp;&quot; octopress-repo)
   (get-buffer-create &quot;*Async Shell Command*&quot;))
  (sleep-for 5)
  (kill-buffer &quot;*Async Shell Command*&quot;))

(add-hook 'after-save-hook #'org-md-try-to-export-to-markdown)
</code></pre>

<p>それで、それぞれのファイルの先頭に以下のように書く。</p>

<pre><code># -*- octopress-export-org-to-md-enabled : t -*-
</code></pre>

<p>もちろんそれは面倒臭い。なので、Rakefileで指定する。
変更点はざっとこんな感じ。
一部は <a href="http://blog.paphus.com/blog/2012/08/01/introducing-octopress-blogging-for-org-mode/" >Introducing Octopress Blogging for Org-Mode</a> を参考にした。</p>

<pre><code>diff --git a/Rakefile b/Rakefile
index d3a1cb0..827ebfe 100644
--- a/Rakefile
+++ b/Rakefile
@@ -23,8 +23,9 @@ deploy_dir      = &quot;_deploy&quot;   # deploy directory (for Github pages deployment)
 stash_dir       = &quot;_stash&quot;    # directory to stash posts for speedy generation
 posts_dir       = &quot;_posts&quot;    # directory for blog files
 themes_dir      = &quot;.themes&quot;   # directory for blog files
-new_post_ext    = &quot;markdown&quot;  # default new post file extension when using the new_post task
-new_page_ext    = &quot;markdown&quot;  # default new page file extension when using the new_page task
+org_posts_dir   = &quot;org&quot;
+new_post_ext    = &quot;org&quot;  # default new post file extension when using the new_post task
+new_page_ext    = &quot;org&quot;  # default new page file extension when using the new_page task
 server_port     = &quot;4000&quot;      # port for preview server eg. localhost:4000


@@ -98,13 +99,17 @@ task :new_post, :title do |t, args|
     title = get_stdin(&quot;Enter a title for your post: &quot;)
   end
   raise &quot;### You haven't set anything up yet. First run `rake install` to set up an Octopress theme.&quot; unless File.directory?(source_dir)
-  mkdir_p &quot;#{source_dir}/#{posts_dir}&quot;
-  filename = &quot;#{source_dir}/#{posts_dir}/#{Time.now.strftime('%Y-%m-%d')}-#{title.to_url}.#{new_post_ext}&quot;
+  mkdir_p &quot;#{org_posts_dir}&quot;
+  filename = &quot;#{org_posts_dir}/#{Time.now.strftime('%Y-%m-%d')}-#{title.to_url}.#{new_post_ext}&quot;
   if File.exist?(filename)
     abort(&quot;rake aborted!&quot;) if ask(&quot;#{filename} already exists. Do you want to overwrite?&quot;, ['y', 'n']) == 'n'
   end
   puts &quot;Creating new post: #{filename}&quot;
   open(filename, 'w') do |post|
+    post.puts &quot;# -*- octopress-export-org-to-md-enabled : t -*-&quot;
+    post.puts &quot;#+title: #{title.gsub(/&amp;/,'&amp;amp;')}&quot;
+    post.puts &quot;#+date: #{Time.now.strftime('%Y-%m-%d %H:%M')}&quot;
+    post.puts &quot;#+begin_MD&quot;
     post.puts &quot;---&quot;
     post.puts &quot;&quot;
     post.puts &quot;title: \&quot;#{title.gsub(/&amp;/,'&amp;amp;')}\&quot;&quot;
@@ -112,6 +117,7 @@ task :new_post, :title do |t, args|
     post.puts &quot;&quot;
     post.puts &quot;&quot;
     post.puts &quot;---&quot;
+    post.puts &quot;#+end_MD&quot;
   end
 end

@@ -140,6 +146,9 @@ task :new_page, :filename do |t, args|
     end
     puts &quot;Creating new page: #{file}&quot;
     open(file, 'w') do |page|
+      page.puts &quot;#+title: #{title}&quot;
+      page.puts &quot;#+date: #{Time.now.strftime('%Y-%m-%d %H:%M')}&quot;
+      page.puts &quot;#+begin_MD&quot;
       page.puts &quot;---&quot;
       page.puts &quot;layout: page&quot;
       page.puts &quot;title: \&quot;#{title}\&quot;&quot;
@@ -148,6 +157,7 @@ task :new_page, :filename do |t, args|
       page.puts &quot;sharing: true&quot;
       page.puts &quot;footer: true&quot;
       page.puts &quot;---&quot;
+      page.puts &quot;#+end_MD&quot;
     end
</code></pre>

<p>とにかく動けばいいやって感じのhackだけど、まあこれでいいでしょ。快適だ
し、わざわざファイル名を変えたりコピーしなくていいし。</p>

<p>注意点。org-modeはgitで取得した最新版(8.0-pre)。旧来のexporterが使えな
くなっているので注意。exportのメニュー画面がだいぶ変更されている。雑然
としていたいままでのexport画面が改良されているのはいい感じだな。
そもそも、今回のこれをやり始めたきっかけは、 <code>org-mode</code> を新しくしたら
 <a href="https://github.com/alexhenning/ORGMODE-Markdown" >orgmode-markdown</a> が使えなくなっていたこと。その主な理由は、
<code>orgmode-markdown</code> の依存している <code>org-export-generic</code> が、最新版では
消去されているから。どうやら、一度oldextフォルダに移されて、しばらくし
たらその全体が消されたようだ。</p>

<p>さて、次の記事は卒論からポートしてきた <code>CL-RRT</code> か、それとも Yet
Another オレオレLisp入門かな…。</p>
 </div>
</article> <nav> <div class="relative-nav">
<a href="/posts/UTAC-leaflet.html">Previous</a><br>
<a href="/posts/オレオレlisp入門.html">Next</a><br>
</div>
</nav> </main>

<footer class="fineprint"> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="/css/cc-by-sa.png" /> </a> by Masataro Asai <a id="coleslaw-logo" href="https://github.com/redline6561/coleslaw"> <img src="/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </footer>
</body>
</html>