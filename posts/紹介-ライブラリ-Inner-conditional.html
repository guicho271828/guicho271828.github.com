<!doctype html>
<!-- Local Variables: mode : html End: -->
<html lang="en">
<head>
<title>CL-USER&gt; (start-up (the engine *bp-ze*))</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> --> <!-- <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-indigo.css"> --> <link href= "/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
<link href= "/css/style.css" rel="stylesheet" type="text/css" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" />

</head>
<body>
<!-- navigation --> <nav class="navigation">
<div class="title"> <a href="/">CL-USER&gt; (start-up (the engine *bp-ze*))</a> </div> <ul> <li> <a href="/profile/"><i class="fa fa-user"     aria-hidden="true"></i><br>Profile</a> </li>
<li> <a href="/publications/"><i class="fa fa-book"     aria-hidden="true"></i><br>Publications</a> </li>
<li> <a href="http://twitter.com/guicho271828"><i class="fa fa-twitter"  aria-hidden="true"></i><br>Twitter</a> </li>
<li> <a href="http://github.com/guicho271828"><i class="fa fa-github"   aria-hidden="true"></i><br>Github</a> </li>
<li> <a href="https://www.linkedin.com/in/masataro-asai-158a0638/"><i class="fa fa-linkedin" aria-hidden="true"></i><br>LinkedIn</a> </li>
 </ul> </nav>
<!-- main --> <main>
<!-- inside main --> <!-- Local Variables: mode : html End: -->
<article class="post"> <header>
<h1 class="pagetitle">紹介: ライブラリ Inner-conditional</h1>
<div class="tags">
Tagged as <a href="/tag/old-blog.html">old-blog</a>
, <a href="/tag/lisp.html">lisp</a>
 </div>
 <div class="date">Written on <time>2013-05-06 20:41</time></div> </time>
</header>
<div class="content">
<p><a href="https://github.com/guicho271828/inner-conditional" >inner-conditional</a> の紹介をします。</p>

<h1>Q.なにができるの?</h1>

<p>A. ループ(など)の中の条件判定を、内側に書いたままで外側に出せます。</p>

<!--more-->

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
    <span class="paren2">(<span class="code">iter <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
          <span class="paren3">(<span class="code">print i</span>)</span>
          <span class="paren3">(<span class="code">inner <span class="paren4">(<span class="code">body</span>)</span>
            <span class="paren4">(<span class="code"><i><span class="symbol">if</span></i> flag
                <span class="paren5">(<span class="code">body <span class="paren6">(<span class="code">princ <span class="string">"loop on"</span></span>)</span></span>)</span>
                <span class="paren5">(<span class="code">body <span class="paren6">(<span class="code">princ <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>と書くと、</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">IF</span></i> FLAG
    <span class="paren2">(<span class="code"><i><span class="symbol">WITH-INNER</span></i> <span class="paren3">(<span class="code">BODY</span>)</span>
      <span class="paren3">(<span class="code">ITER
        <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
        <span class="paren4">(<span class="code">PRINT I</span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop on"</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><i><span class="symbol">WITH-INNER</span></i> <span class="paren3">(<span class="code">BODY</span>)</span>
      <span class="paren3">(<span class="code">ITER
        <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
        <span class="paren4">(<span class="code">PRINT I</span>)</span>
        <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
</span></code></pre>

<p>になって、</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">IF</span></i> FLAG
    <span class="paren2">(<span class="code"><i><span class="symbol">PROGN</span></i>
     <span class="paren3">(<span class="code">ITER
       <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
       <span class="paren4">(<span class="code">PRINT I</span>)</span>
       <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop on"</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren2">(<span class="code"><i><span class="symbol">PROGN</span></i>
     <span class="paren3">(<span class="code">ITER
       <span class="paren4">(<span class="code">FOR I FROM 0 TO 5</span>)</span>
       <span class="paren4">(<span class="code">PRINT I</span>)</span>
       <span class="paren4">(<span class="code"><i><span class="symbol">PROGN</span></i> <span class="paren5">(<span class="code">PRINC <span class="string">"loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
</span></code></pre>

<p>になります。うふふ、いいでしょ。キモイ？</p>

<p>この種のループ最適化というと、もとから全て行なってくれるような、とって
も優れた処理系もあるかもしれませんが、なにせ実際に動いているのかどうか
わかりません。(C言語とかって、賢いコンパイラはこういうのが全部デフォルト
で付いているんですかね？) sbclでテストをした結果、 <strong>たしかに</strong> <a href="https://github.com/guicho271828/inner-conditional/blob/master/opt-results.org" >条件判定
の分だけ早くなっていることが確認出来ました。</a></p>

<p>条件判定のタイミングは <code>with-inner</code> の部分ですので、 <code>with-inner</code> をど
こに置くかで判定のタイミングを適切に設定できます。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
  <span class="paren2">(<span class="code">iter <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
        <span class="paren3">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren4">(<span class="code">body2</span>)</span>
          <span class="paren4">(<span class="code">iter <span class="paren5">(<span class="code">for j from 0 to 5</span>)</span>
                <span class="paren5">(<span class="code">format t <span class="string">"~%i: ~a j: ~a"</span> i j</span>)</span>
                <span class="paren5">(<span class="code">inner <span class="paren6">(<span class="code">body2</span>)</span>
                  <span class="paren6">(<span class="code"><i><span class="symbol">if</span></i> <span class="paren1">(<span class="code">evenp i</span>)</span>
                      <span class="paren1">(<span class="code">body2 <span class="paren2">(<span class="code">format t <span class="string">"  i is even"</span></span>)</span></span>)</span>
                      <span class="paren1">(<span class="code">body2 <span class="paren2">(<span class="code">format t <span class="string">"  i is odd"</span></span>)</span></span>)</span></span>)</span></span>)</span>
                <span class="paren5">(<span class="code">inner-if body flag
                          <span class="paren6">(<span class="code">format t <span class="string">"  loop on"</span></span>)</span>
                          <span class="paren6">(<span class="code">format t <span class="string">"  loop off"</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>この例では、 <code>body</code> レベルでの条件判定は一番上で、一方 <code>body2</code> レベルの
条件判定はループの二段目で行えます。 <code>inner</code> の方、すなわり条件判定の内
容を実際に書いている方で、そのレベルを指定できます。 <code>(inner-if body
...)</code> というのは構文糖で、 <code>(inner (body) (if ... (body ...)))</code> に展開
されるマクロです。ほかにも数種類あります。</p>

<p><code>inner</code> 内で使えるのは <code>if</code> だけじゃありません。 <code>cond</code> でも、 <code>case</code>
でも、オレオレマクロでもなんでも大丈夫です。特殊なマクロで制御構造を登
録する必要はありません。必要なのはこれだけ、すなわち、</p>

<pre><code>継続であるかのように body を呼ぶこと
</code></pre>

<p>です。</p>

<pre><code><span class="code"><span class="paren1">(<span class="code"><i><span class="symbol">with-inner</span></i> <span class="paren2">(<span class="code">body</span>)</span>
  <span class="paren2">(<span class="code">iter
    <span class="paren3">(<span class="code">for i from 0 to 5</span>)</span>
    <span class="paren3">(<span class="code">inner <span class="paren4">(<span class="code">body</span>)</span>
      <span class="paren4">(<span class="code">case <span class="paren5">(<span class="code"><i><span class="symbol">progn</span></i> <span class="paren6">(<span class="code">incf count</span>)</span>
                   <span class="paren6">(<span class="code">mod arg 3</span>)</span></span>)</span>
        <span class="paren5">(<span class="code">0 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"divided. i*3 =~a~%"</span>
                         <span class="paren2">(<span class="code">* i 3</span>)</span></span>)</span>
                 <span class="paren1">(<span class="code">format t <span class="string">"divided. i*3 =~a~%"</span>
                         <span class="paren2">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">1 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"modulo 1. i*3 + 1 =~a~%"</span>
                         <span class="paren2">(<span class="code">+ 1 <span class="paren3">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
        <span class="paren5">(<span class="code">2 <span class="paren6">(<span class="code">body <span class="paren1">(<span class="code">format t <span class="string">"modulo 2. i*3 + 2 =~a~%"</span>
                         <span class="paren2">(<span class="code">+ 2 <span class="paren3">(<span class="code">* i 3</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span></code></pre>

<p>だってほら、全然違いますけど、内側と外側がひっくり返るじゃないですか。
プログラムは実際には <strong>一番最初に</strong> 条件分岐をして、そして <code>inner</code> の中身
が <code>body</code> の引数を代入した状態で実行されるんです。似てませんか？ <strong>継続
に！</strong></p>

<p>続きはまた今度。このライブラリのもうひとつのいいところ、 あなたのライブ
ラリに、 <strong>条件分岐を隠したまま最適化できる能力</strong> を与えられる点について
お話しします。</p>
 </div>
</article> <nav> <div class="relative-nav">
<a href="/posts/Common-Lisp-で-Code-Walker-を実装するなら-その②.html">Previous</a><br>
<a href="/posts/ひさしぶりの更新.html">Next</a><br>
</div>
</nav> </main>

<!-- footer --> <footer> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="/css/cc-by-sa.png" /> </a> by Masataro Asai <br> <a href="https://github.com/redline6561/coleslaw"> <img src="/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </footer>
</body>
</html>